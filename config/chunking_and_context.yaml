# chunking_and_context.yaml
# ==========================
# Controls text chunking and semantic boundary detection.
# Used by: modules/core/chunking_service.py, modules/operations/line_ranges/readjuster.py
#
# Note: Context is now resolved automatically via modules/core/context_resolver.py
# using hierarchical fallback (file-specific > folder-specific > schema-specific > global).
# See context/extraction/ and context/line_ranges/ directories.

# ── Chunking ───────────────────────────────────────────────────────────────────
# Controls how source text is split into chunks for LLM processing.
chunking:
  default_tokens_per_chunk: 3000   # Target chunk size in tokens (not characters)
                                   # Larger = fewer API calls but may hit context limits
                                   # Smaller = more granular but higher API costs

# ── Matching ───────────────────────────────────────────────────────────────────
# Text normalization settings for semantic boundary marker matching.
# These control how the LLM's suggested boundary markers are matched against source text.
# Used by: modules/operations/line_ranges/readjuster.py
matching:
  normalize_whitespace: true       # Collapse multiple whitespace chars into single spaces
  case_sensitive: false            # When false, "CHAPTER" matches "chapter"
  normalize_diacritics: true       # Remove accents/umlauts (é→e, ü→u)
                                   # Useful for historical texts with inconsistent encoding
  strip_punctuation: false         # Remove punctuation before matching
                                   # Keep false if punctuation is semantic (e.g., "§ 1." vs "§ 2.")
  allow_substring_match: true      # Allow marker to match within a line (not just whole line)
  min_substring_length: 3          # Minimum chars for valid substring match
                                   # Prevents false positives from very short markers

# ── Retry ──────────────────────────────────────────────────────────────────────
# Retry and validation settings for semantic boundary detection.
# Controls how the system handles low-confidence or failed boundary detections.
# Used by: modules/operations/line_ranges/readjuster.py
retry:
  certainty_threshold: 70          # Minimum confidence (0-100) to accept LLM response
                                   # Below this triggers retry with adjusted context
  max_low_certainty_retries: 15    # Max retries when confidence is below threshold
  max_marker_mismatch_retries: 15  # Max attempts to request alternative markers
                                   # when suggested markers don't match source text
  max_context_expansion_attempts: 6 # Max times to expand visible context window
                                   # when LLM signals needs_more_context
  delete_ranges_with_no_content: true  # Remove line ranges confirmed to have no semantic content
  scan_range_multiplier: 2         # Multiplier for verification scan area
                                   # Scans (range_size × multiplier) lines around boundary
  max_gap_between_ranges: 2        # Maximum unassigned lines allowed between ranges
                                   # Set to 0 for flush ranges; increase for looser alignment